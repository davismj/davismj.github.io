<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    <title>Aurelia Authentication&#58; Sessions. â€“ Matthew James Davis</title>

    <meta name="author" content="Matthew James Davis" />
    <meta name="description" content="Best practices for keeping track of logged in users." />
    <meta name="keywords" content="aurelia,login,auth,best-practices" />

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href='https://fonts.googleapis.com/css?family=Raleway:500,600' rel='stylesheet' type='text/css'>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="stylesheet" type="text/css" href="/desktop.css" media="screen and (min-width: 641px) and (min-height: 641px)" />
    <link rel="stylesheet" type="text/css" href="/mobile.css" media="screen and (max-width: 640px), screen and (max-height: 640px)" />
    <link rel="alternate" type="application/rss+xml" title="Matthew James Davis" href="/feed.xml" />
  </head>

  <body>
    <nav>
      <div>
        <a href="/"><img class="avatar" src="/images/me.jpg" />
        <h1 class="text-center">Matthew James Davis</h1></a>
        <p class="hide-mobile">Aurelia core team member Matthew James Davis is out to educate the community.</p>
        <ul>
          <a href="/blog/"><li class="active">Blog</li></a>
          <a href="/portfolio/"><li class="">Portfolio</li></a>
          <a href="/contact/"><li class="">Contact Me</li></a>
        </ul>
      </div>
    </nav>
    
    <main>
      <article>
	<header>
		Aurelia Authentication&#58; Sessions.
		<time>22 Sep 2015</time>
	</header>
	<p>Last time we looked at best practices for creating a login page leveraging Aurelia roots. This time we&#39;re going to look at how to build a service that can handle tracking information about authentication between sessions, and can communicate to the various parts of your application</p>

<h1>Singletons and Transients</h1>

<p>Aurelia has two modes of loading classes (or modules) with the dependency injection framework. One is <em>transient</em> mode, which means that a new instance of the class is created every time the dependency is injected. The other is <em>singleton</em> mode, which means that only one instance is created and the same instance is passed to each depndency injection. In general, transients should only be used when you expect to have multiple instances of that class alive in your app at the same time. The default mode is singleton.</p>

<h1>Configuring AuthService</h1>

<p>First, we&#39;re going to need to define a few parameters to pass to AuthService:</p>

<ol>
<li>Where the service is located.</li>
<li>What endpoints are available.</li>
<li>Where to store the session information.</li>
</ol>

<h4>src/config.js</h4>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// If this service was abstracted to a plugin, we would instead pass</span>
<span class="c1">// this information to the plugin&#39;s config function. For now, we </span>
<span class="c1">// export this object for simplicity. In a larger application, there</span>
<span class="c1">// would be other, unrelated settings in the config as well.</span>
<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">&#39;http://www.mocky.io/v2/&#39;</span><span class="p">,</span>
  <span class="nx">loginUrl</span><span class="o">:</span> <span class="s1">&#39;560122ef9635789e120aa366&#39;</span><span class="p">,</span>
  <span class="nx">tokenName</span><span class="o">:</span> <span class="s1">&#39;ah12h3&#39;</span>
<span class="p">};</span>
</code></pre></div>
<h1>Creating the AuthService</h1>

<p>We want to create a general <code>AuthService</code> that any part of the application can use to perform authentication related tasks; since there is one service throughout the application, it needs to be a singleton. </p>

<p>There are a few things the <code>AuthService</code> needs to do:</p>

<ol>
<li>On load, it needs to remember the most recent login information.</li>
<li>It needs to expose login and logout functions.</li>
<li>Any part of the aurelia app should be able to query for current status.</li>
</ol>

<h4>src/AuthService.js</h4>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kr">import</span> <span class="nx">config</span> <span class="nx">from</span> <span class="s1">&#39;config&#39;</span><span class="p">;</span>

<span class="err">@</span><span class="nx">inject</span><span class="p">(</span><span class="nx">Aurelia</span><span class="p">,</span> <span class="nx">HttpClient</span><span class="p">)</span>
<span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">AuthService</span> <span class="p">{</span>

  <span class="c1">// As soon as the AuthService is created, we query local storage to</span>
  <span class="c1">// see if the login information has been stored. If so, we immediately</span>
  <span class="c1">// load it into the session object on the AuthService.</span>
  <span class="nx">constructor</span><span class="p">(</span><span class="nx">Aurelia</span><span class="p">,</span> <span class="nx">HttpClient</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">HttpClient</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="nx">http</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">http</span><span class="p">.</span><span class="nx">withBaseUrl</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">http</span> <span class="o">=</span> <span class="nx">HttpClient</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="nx">Aurelia</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">tokenName</span><span class="p">]</span> <span class="o">||</span> <span class="kc">null</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// The login function needs to abstract away all of the details about</span>
  <span class="c1">// how we track and expose login information. A more advanced app might</span>
  <span class="c1">// want the login function to pass back a promise so it can perform</span>
  <span class="c1">// additional tasks on login, but we keep things simple here.</span>
  <span class="nx">login</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">http</span>
      <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">loginUrl</span><span class="p">,</span> <span class="p">{</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">session</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">localStorage</span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">tokenName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">session</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="nx">session</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">setRoot</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// The logout function reverses the actions of the login function. </span>
  <span class="c1">// It is less common for logout to be async, but logout could also</span>
  <span class="c1">// return a promise if there were a need.</span>
  <span class="nx">logout</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">localStorage</span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">tokenName</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">setRoot</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// A basic method for exposing information to other modules.  </span>
  <span class="nx">isAuthenticated</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h1>Using the AuthService</h1>

<p>Now we can begin using the <code>AuthService</code> module throughout our application. </p>

<h4>src/main.js</h4>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// After starting the aurelia, we can request the AuthService directly</span>
<span class="c1">// from the DI container on the aurelia object. We can then set the </span>
<span class="c1">// correct root by querying the AuthService&#39;s isAuthenticated method.</span>
<span class="nx">aurelia</span><span class="p">.</span><span class="nx">start</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">aurelia</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">AuthService</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">()</span> <span class="o">?</span> <span class="s1">&#39;app&#39;</span> <span class="o">:</span> <span class="s1">&#39;login&#39;</span><span class="p">;</span>
  <span class="nx">aurelia</span><span class="p">.</span><span class="nx">setRoot</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<h4>src/app.html</h4>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="c">&lt;!-- We can call the logout() method directly from the AuthService. --&gt;</span>
<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav navbar-nav navbar-right&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">click</span><span class="err">.</span><span class="na">delegate=</span><span class="s">&quot;auth.logout()&quot;</span><span class="nt">&gt;</span>Log Out<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</code></pre></div>
<h4>src/login.js</h4>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Or, if we want to add additional logic to the function, </span>
<span class="c1">// we can call it within another method on our view model.</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">Login</span> <span class="p">{</span>
  <span class="nx">login</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">username</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="s1">&#39;Please enter a username and password.&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h1>Notes</h1>

<p>There are a few placeholders in the source code that I may dive into in another blog post. In particular, the <code>can(permission)</code> method on the login service can be used in conjunction with an enum or object and a bitmask on the server to greatly simplify handling permissions. Also, the mock API passes back a hash value. An even better practice would be to add a call to a verification endpoint that takes in a hash and returns the correlated session object. This would prevent a user from tampering with local storage. However, for both of these items, <strong>you must always double check a user&#39;s permission on the server</strong>. You can never be sure that the client hasn&#39;t been hacked; this is one of the drawbacks to single-page applications.</p>

<p>When writing this blog, I stumbled onto a bug where logging in, out, and back in again caused the router-view in app.html to deactivate permanently. I hvae created an issue here: <a href="https://github.com/aurelia/framework/issues/212">https://github.com/aurelia/framework/issues/212</a>.</p>

<h1>Links</h1>

<p><a href="https://davismj.github.io/aurelia-session-example">Working Demo</a><br />
<a href="https://github.com/davismj/aurelia-session-example">Full Source in Github</a><br />
<a href="http://www.mocky.io/">App for Mocking REST APIs</a><br />
<a href="http://blog.opinionatedapps.com/aureliauth-a-token-based-authentication-plugin-for-aurelia/">Aurelia OAuth2 Plugin</a><br />
<a href="http://davismj.me/blog/aurelia-login-best-practices-pt-1/">Aurelia Auth Best Practices: Multiple Shells</a><br />
<a href="http://www.cheatography.com/erikch/cheat-sheets/aurelia-getting-started/">Aurelia Getting Started Cheat Sheet</a><br />
<a href="http://hobbit-on-aurelia.net/appstate/">Michael Lambert on App State Services</a><br />
<a href="http://patrickwalters.net/my-best-practices-for-aurelia-application-structure/">Patrick Walters on App Organization</a><br /></p>

</article>
<!-- 
<footer>
	
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">
    
	    var disqus_shortname = 'foursails'; 

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</footer> -->
    </main>
    
    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		
		ga('create', 'UA-58706961-2', 'auto');
		ga('send', 'pageview');
	</script>
	<!-- End Google Analytics -->

  </body>
</html>
